# Ingress Configuration for Smart News Aggregator
# Requires Ingress Controller (nginx-ingress, traefik, и т.д.)

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: smart-news-ingress
  namespace: smart-news
  annotations:
    # NGINX Ingress Controller annotations
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/limit-connections: "5"
    
    # CORS (если нужно)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    
    # Request size
    nginx.ingress.kubernetes.io/proxy-body-size: "20m"
    
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # Cert Manager для автоматических SSL сертификатов
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"

spec:
  # TLS configuration
  tls:
    - hosts:
        - api.smartnews.com
        - ml.smartnews.com
      secretName: smartnews-tls  # Создайте этот secret
  
  rules:
    # Backend API
    - host: api.smartnews.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8000
    
    # ML Service API
    - host: ml.smartnews.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ml-service
                port:
                  number: 8001
    
    # Unified domain approach (альтернатива)
    # - host: smartnews.com
    #   http:
    #     paths:
    #       - path: /api
    #         pathType: Prefix
    #         backend:
    #           service:
    #             name: backend
    #             port:
    #               number: 8000
    #       
    #       - path: /ml
    #         pathType: Prefix
    #         backend:
    #           service:
    #             name: ml-service
    #             port:
    #               number: 8001
    #       
    #       - path: /
    #         pathType: Prefix
    #         backend:
    #           service:
    #             name: frontend
    #             port:
    #               number: 3000

---

# Certificate (для cert-manager)
# apiVersion: cert-manager.io/v1
# kind: Certificate
# metadata:
#   name: smartnews-tls
#   namespace: smart-news
# spec:
#   secretName: smartnews-tls
#   issuerRef:
#     name: letsencrypt-prod
#     kind: ClusterIssuer
#   dnsNames:
#     - api.smartnews.com
#     - ml.smartnews.com
#     - smartnews.com
#     - www.smartnews.com

---

# Ingress для внутренних сервисов (мониторинг)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-ingress
  namespace: smart-news
  annotations:
    kubernetes.io/ingress.class: "nginx"
    # Basic Auth для защиты
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
spec:
  rules:
    # Grafana
    - host: grafana.smartnews.internal
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 3000
    
    # Prometheus
    - host: prometheus.smartnews.internal
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus
                port:
                  number: 9090
    
    # Flower (Celery)
    - host: flower.smartnews.internal
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: flower
                port:
                  number: 5555

---

# Basic Auth Secret (создайте вручную)
# htpasswd -c auth admin
# kubectl create secret generic monitoring-basic-auth \
#   --from-file=auth \
#   --namespace=smart-news
